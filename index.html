<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DTM • DENMAR Transit Map</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        #map { height: 100%; width: 100%; z-index: 1; }
        .custom-div-icon { background: none; border: none; }
        
        .marker-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 44px;
        }

        .direction-badge {
            background: white;
            color: #1e293b;
            font-size: 10px;
            font-weight: 900;
            padding: 1px 4px;
            border-radius: 4px;
            border: 1.5px solid #cbd5e1;
            margin-bottom: -4px;
            z-index: 20;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            letter-spacing: -0.025em;
        }

        .streetcar-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border: 2.5px solid white;
            border-radius: 50%;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            transition: transform 0.8s linear, top 0.8s linear, left 0.8s linear;
        }
        
        /* 509 Blue */
        .route-509-color { background-color: #2563eb; }
        
        /* 510A Vibrant Red */
        .route-510-color { background-color: #dc2626; }
        
        /* 510B Muted Branch */
        .route-510b-muted { 
            background-color: #64748b; 
            opacity: 0.9;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .stop-marker {
            background: #1e293b;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2.5px solid white;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
        }

        .route-label-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .loading-pulse { animation: pulse-soft 2s infinite; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 overflow-hidden h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b px-6 py-3 flex items-center justify-between shadow-sm z-20">
        <div class="flex items-center gap-3">
            <div class="flex-shrink-0">
                <img src="https://images.squarespace-cdn.com/content/v2/namespaces/memberAccountAvatars/libraries/5554fc6be4b010ac6e753e8b/0620c9d8550a4f6b9d79ed1a12fb2f60/0620c9d8550a4f6b9d79ed1a12fb2f60.jpeg?format=300w" 
                     alt="DENMAR Logo" 
                     class="h-10 w-10 rounded-full border-2 border-slate-100 shadow-sm object-cover">
            </div>
            <div>
                <h1 class="text-lg font-black tracking-tight uppercase leading-none">
                    DENMAR Transit Map (DTM)
                </h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-1">For DENMAR personal use, but you can use it too!</p>
            </div>
        </div>

        <div class="hidden lg:flex items-center gap-4">
            <div class="flex bg-slate-100 p-1 rounded-xl border border-slate-200">
                <button id="toggle-509" onclick="toggleRoute('509')" class="px-5 py-1.5 rounded-lg text-xs font-black transition-all bg-blue-600 text-white shadow-md">
                    509
                </button>
                <button id="toggle-510" onclick="toggleRoute('510')" class="px-5 py-1.5 rounded-lg text-xs font-black transition-all bg-red-600 text-white shadow-md ml-1">
                    510
                </button>
            </div>
            <div class="text-right border-l pl-4 min-w-[140px]">
                <p id="last-updated-text" class="text-[10px] font-mono font-bold text-slate-400 tracking-tighter uppercase">Initializing...</p>
            </div>
        </div>
        
        <button onclick="forceUpdate()" id="refresh-btn" class="p-2.5 bg-slate-100 hover:bg-slate-200 rounded-full transition-all active:scale-90 group">
            <i data-lucide="refresh-cw" id="refresh-icon" class="h-4 w-4 text-slate-600"></i>
        </button>
    </header>

    <!-- Map Area -->
    <main class="flex-1 relative">
        <div id="map"></div>

        <!-- Route Indicator Overlay -->
        <div class="absolute top-4 left-4 z-[1000] space-y-2 pointer-events-none lg:pointer-events-auto">
            <div id="card-509" class="route-label-card p-3 rounded-xl shadow-lg border-l-4 border-blue-600 flex items-center gap-3 w-56">
                <div class="bg-blue-600 text-white font-black px-2 py-0.5 rounded text-[10px]">509</div>
                <div>
                    <p class="text-[9px] font-black text-slate-400 uppercase leading-none mb-0.5">Harbourfront</p>
                    <p class="text-[11px] font-bold text-slate-800">Union ↔ Exhibition</p>
                </div>
            </div>
            <div id="card-510" class="route-label-card p-3 rounded-xl shadow-lg border-l-4 border-red-600 flex flex-col gap-2 w-56">
                <div class="flex items-center gap-3">
                    <div class="bg-red-600 text-white font-black px-2 py-0.5 rounded text-[10px]">510A</div>
                    <div>
                        <p class="text-[9px] font-black text-slate-400 uppercase leading-none mb-0.5">Spadina Main</p>
                        <p class="text-[11px] font-bold text-slate-800">Direct to Union</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Initial Loader -->
        <div id="initial-loader" class="absolute inset-0 z-[2000] bg-white flex flex-col items-center justify-center transition-opacity duration-500">
            <div class="flex flex-col items-center gap-4">
                <div class="relative">
                    <div class="h-16 w-16 border-4 border-slate-100 border-t-blue-600 rounded-full animate-spin"></div>
                    <i data-lucide="radio" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-slate-300 h-6 w-6"></i>
                </div>
                <div class="text-center">
                    <p class="font-black text-slate-800 tracking-widest uppercase text-[10px]">Pinging TTC API</p>
                    <p class="text-[10px] text-slate-400 font-bold mt-1 loading-pulse italic uppercase">Acquiring Fleet GPS...</p>
                </div>
            </div>
        </div>

        <!-- Fleet Stats Panel -->
        <div class="absolute bottom-6 right-6 w-64 bg-white/95 backdrop-blur shadow-2xl rounded-2xl p-4 border border-white z-[1000] hidden md:block">
            <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-100">
                <div class="flex items-center gap-2">
                    <div class="h-1.5 w-1.5 bg-green-500 rounded-full animate-pulse"></div>
                    <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Active Fleet</span>
                </div>
                <span id="total-count" class="text-[9px] font-black bg-slate-100 px-2 py-0.5 rounded-full text-slate-600">0 UNITS</span>
            </div>
            <div class="space-y-2.5">
                <div class="flex items-center justify-between">
                    <span class="text-xs font-bold text-slate-700">509 Harbourfront</span>
                    <span id="count-509" class="text-[10px] font-mono font-black text-blue-600 bg-blue-50 px-2 py-0.5 rounded">0</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-xs font-bold text-slate-700">510A/B Spadina</span>
                    <span id="count-510" class="text-[10px] font-mono font-black text-red-600 bg-red-50 px-2 py-0.5 rounded">0</span>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Navigation -->
    <footer class="md:hidden bg-white border-t px-4 py-2 flex justify-around items-center z-20 shadow-lg">
        <button onclick="toggleRoute('509')" id="mobile-toggle-509" class="flex-1 flex flex-col items-center py-1">
            <div id="bar-509" class="h-1 w-8 rounded-full mb-1 bg-blue-600"></div>
            <span class="text-[10px] font-black uppercase tracking-tighter">509</span>
        </button>
        <button onclick="toggleRoute('510')" id="mobile-toggle-510" class="flex-1 flex flex-col items-center py-1">
            <div id="bar-510" class="h-1 w-8 rounded-full mb-1 bg-red-600"></div>
            <span class="text-[10px] font-black uppercase tracking-tighter">510</span>
        </button>
    </footer>

    <script>
        const API_BASE = 'https://retro.umoiq.com/service/publicXMLFeed';
        const UPDATE_INTERVAL = 5000; // 5 seconds polling
        
        let map;
        let vehicleMarkers = {}; 
        let activeRoutes = ['509', '510'];
        let isUpdating = false;

        const KEY_STOPS = [
            { name: "Union Station", lat: 43.645645, lon: -79.379174, desc: "Line 1 Connection" },
            { name: "Harbourfront Centre", lat: 43.639609, lon: -79.381962, desc: "Queens Quay Terminal" },
            { name: "Spadina & QQ", lat: 43.6373, lon: -79.3926, desc: "510 Turnback Point" }
        ];

        window.onload = function() {
            lucide.createIcons();
            initMap();
            updateData();
            
            // Core data loop
            setInterval(updateData, UPDATE_INTERVAL);
            
            // Secondary loop just to update the "Reported Xs ago" text in open popups
            setInterval(updatePopupTimers, 1000);
        };

        function initMap() {
            map = L.map('map', { 
                zoomControl: false,
                attributionControl: false 
            }).setView([43.641, -79.388], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(map);

            L.control.zoom({ position: 'topright' }).addTo(map);

            KEY_STOPS.forEach(stop => {
                const stopIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="stop-marker" title="${stop.name}"></div>`,
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                });
                L.marker([stop.lat, stop.lon], { icon: stopIcon }).addTo(map)
                    .bindPopup(`<div class="p-1"><b class="text-xs font-black uppercase">${stop.name}</b><p class="text-[10px] text-slate-400 font-bold uppercase mt-1 tracking-tight">${stop.desc}</p></div>`);
            });
        }

        function getCardinal(heading) {
            if (heading >= 337.5 || heading < 22.5) return 'NB';
            if (heading >= 22.5 && heading < 67.5) return 'NE';
            if (heading >= 67.5 && heading < 112.5) return 'EB';
            if (heading >= 112.5 && heading < 157.5) return 'SE';
            if (heading >= 157.5 && heading < 202.5) return 'SB';
            if (heading >= 202.5 && heading < 247.5) return 'SW';
            if (heading >= 247.5 && heading < 292.5) return 'WB';
            if (heading >= 292.5 && heading < 337.5) return 'NW';
            return '--';
        }

        function forceUpdate() {
            updateData();
        }

        async function updateData() {
            if (isUpdating) return;
            isUpdating = true;
            
            const refreshIcon = document.getElementById('refresh-icon');
            if (refreshIcon) refreshIcon.classList.add('animate-spin');

            try {
                const results = await Promise.all(
                    activeRoutes.map(route => fetchVehicles(route))
                );
                
                const allVehicles = results.flat();
                renderVehicles(allVehicles);
                
                const now = new Date();
                document.getElementById('last-updated-text').innerText = 'Synced @ ' + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
                
                const count509 = allVehicles.filter(v => v.route === '509').length;
                const count510 = allVehicles.filter(v => v.route === '510').length;
                
                document.getElementById('count-509').innerText = count509;
                document.getElementById('count-510').innerText = count510;
                document.getElementById('total-count').innerText = allVehicles.length + ' UNITS';
                
                const loader = document.getElementById('initial-loader');
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.remove(), 500);
                }
            } catch (error) {
                console.error("Sync Error:", error);
            } finally {
                isUpdating = false;
                if (refreshIcon) refreshIcon.classList.remove('animate-spin');
            }
        }

        async function fetchVehicles(routeTag) {
            try {
                const url = `${API_BASE}?command=vehicleLocations&a=ttc&r=${routeTag}&t=0`;
                const response = await fetch(url);
                const text = await response.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, 'text/xml');
                
                return Array.from(xml.querySelectorAll('vehicle')).map(v => {
                    const dirTag = v.getAttribute('dirTag') || '';
                    const isMuted = routeTag === '510' && dirTag.includes('510B');
                    
                    return {
                        id: v.getAttribute('id'),
                        route: routeTag,
                        branch: isMuted ? '510B' : (routeTag === '510' ? '510A' : '509'),
                        lat: parseFloat(v.getAttribute('lat')),
                        lon: parseFloat(v.getAttribute('lon')),
                        heading: parseFloat(v.getAttribute('heading')),
                        speed: parseFloat(v.getAttribute('speedKmHr')),
                        secsSinceReport: parseInt(v.getAttribute('secsSinceReport')),
                        isMuted: isMuted,
                        fetchedAt: Date.now()
                    };
                });
            } catch (e) { return []; }
        }

        function renderVehicles(vehicles) {
            const currentIds = new Set(vehicles.map(v => v.id));

            Object.keys(vehicleMarkers).forEach(id => {
                if (!currentIds.has(id)) {
                    map.removeLayer(vehicleMarkers[id]);
                    delete vehicleMarkers[id];
                }
            });

            vehicles.forEach(v => {
                const cardinal = getCardinal(v.heading);
                let colorClass = '';
                
                if (v.route === '509') {
                    colorClass = 'route-509-color';
                } else {
                    colorClass = v.isMuted ? 'route-510b-muted' : 'route-510-color';
                }
                
                const iconHtml = `
                    <div class="marker-container" id="marker-${v.id}">
                        <div class="direction-badge">${cardinal}</div>
                        <div class="streetcar-marker ${colorClass}" style="transform: rotate(${v.heading}deg)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2L4.5 20.29L5.21 21L12 18L18.79 21L19.5 20.29L12 2Z" />
                            </svg>
                        </div>
                    </div>
                `;

                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: iconHtml,
                    iconSize: [44, 48],
                    iconAnchor: [22, 24]
                });

                const popupContent = `
                    <div class="p-1 min-w-[140px]">
                        <div class="flex items-center justify-between mb-2 pb-1.5 border-b border-slate-100">
                            <span class="text-[10px] font-black bg-slate-100 px-2 py-0.5 rounded uppercase tracking-tighter">${v.branch}</span>
                            <span class="text-[10px] font-bold text-slate-400">CAR #${v.id}</span>
                        </div>
                        <p class="text-xs font-bold text-slate-800">${cardinal} Heading @ ${v.speed} km/h</p>
                        <p class="text-[9px] text-slate-400 font-bold uppercase mt-1 tracking-tight">
                            Reported <span class="live-report-timer" data-start="${v.secsSinceReport}" data-fetched="${v.fetchedAt}">${v.secsSinceReport}</span>s ago
                        </p>
                    </div>
                `;

                if (vehicleMarkers[v.id]) {
                    vehicleMarkers[v.id].setLatLng([v.lat, v.lon]);
                    vehicleMarkers[v.id].setIcon(icon);
                    if (vehicleMarkers[v.id].getPopup()) {
                        vehicleMarkers[v.id].getPopup().setContent(popupContent);
                    }
                } else {
                    const marker = L.marker([v.lat, v.lon], { icon }).addTo(map);
                    marker.bindPopup(popupContent);
                    vehicleMarkers[v.id] = marker;
                }
            });
        }

        function updatePopupTimers() {
            document.querySelectorAll('.live-report-timer').forEach(span => {
                const baseSecs = parseInt(span.getAttribute('data-start'));
                const fetchedAt = parseInt(span.getAttribute('data-fetched'));
                const elapsedSinceFetch = Math.floor((Date.now() - fetchedAt) / 1000);
                span.innerText = baseSecs + elapsedSinceFetch;
            });
        }

        function toggleRoute(route) {
            if (activeRoutes.includes(route)) {
                if (activeRoutes.length === 1) return;
                activeRoutes = activeRoutes.filter(r => r !== route);
            } else {
                activeRoutes.push(route);
            }
            
            Object.values(vehicleMarkers).forEach(m => map.removeLayer(m));
            vehicleMarkers = {};
            
            updateButtonUI();
            updateData();
        }

        function updateButtonUI() {
            const is509 = activeRoutes.includes('509');
            const is510 = activeRoutes.includes('510');
            
            const btn509 = document.getElementById('toggle-509');
            const btn510 = document.getElementById('toggle-510');

            btn509.className = is509 
                ? "px-5 py-1.5 rounded-lg text-xs font-black transition-all bg-blue-600 text-white shadow-md"
                : "px-5 py-1.5 rounded-lg text-xs font-black transition-all text-slate-400 bg-slate-100 hover:bg-slate-200";
            
            btn510.className = is510 
                ? "px-5 py-1.5 rounded-lg text-xs font-black transition-all bg-red-600 text-white shadow-md ml-1"
                : "px-5 py-1.5 rounded-lg text-xs font-black transition-all text-slate-400 bg-slate-100 hover:bg-slate-200 ml-1";

            document.getElementById('bar-509').className = `h-1 w-8 rounded-full mb-1 ${is509 ? 'bg-blue-600' : 'bg-slate-200'}`;
            document.getElementById('bar-510').className = `h-1 w-8 rounded-full mb-1 ${is510 ? 'bg-red-600' : 'bg-slate-200'}`;
            
            document.getElementById('card-509').style.opacity = is509 ? "1" : "0.2";
            document.getElementById('card-510').style.opacity = is510 ? "1" : "0.2";
        }
    </script>
</body>
</html>